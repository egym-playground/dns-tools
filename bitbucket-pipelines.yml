options:
  max-time: 10
  docker: true

clone:
  depth: 3

pipelines:
  default:
  - step:
      name: test
      image: golang:latest
      script:
      # prepare environment
      # BEGIN TEMPORARY FIX for https://github.com/golang/lint/issues/397
      - mkdir -p $GOPATH/src/golang.org/x
      - git clone --depth 1 https://github.com/golang/lint.git $GOPATH/src/golang.org/x/lint
      # END TEMPORARY FIX
      - go get -u golang.org/x/lint/golint
      - PACKAGE_PATH="${GOPATH}/src/bitbucket.org/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}"
      - mkdir -pv "${PACKAGE_PATH}"
      - tar -cO --exclude-vcs --exclude=bitbucket-pipelines.yml . | tar -xv -C "${PACKAGE_PATH}"
      - cd "${PACKAGE_PATH}"
      # run tests
      - golint   -set_exit_status $(go list ./... | grep -v /vendor/)
      - go vet   -v               $(go list ./... | grep -v /vendor/)
      - go build -v               $(go list ./... | grep -v /vendor/)
      - go test  -v -race         $(go list ./... | grep -v /vendor/)
